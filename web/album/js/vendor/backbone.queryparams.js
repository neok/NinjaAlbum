!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return b(c||a._,d||a.Backbone)}):"object"==typeof exports?module.exports=b(require("underscore"),require("backbone")):b(_,Backbone)}(this,function(a,b){function c(d,e){function f(a){return String(a).replace(g,encodeURIComponent(g))}var g=b.Router.arrayValueSplit;if(!d)return"";e=e||"";var h=[];return a.each(d,function(b,d){if(d=e+d,a.isString(b)||a.isNumber(b)||a.isBoolean(b)||a.isDate(b))null!=b&&h.push(d+"="+f(encodeURIComponent(b)));else if(a.isArray(b)){for(var i="",j=0;j<b.length;j++){var k=b[j];null!=k&&(i+=g+f(k))}i&&h.push(d+"="+i)}else{var l=c(b,d+".");l&&h.push(l)}}),h.join("&")}function d(a){try{return decodeURIComponent(a.replace(/\+/g," "))}catch(b){return a}}function e(b,c){var d=b.split("&");a.each(d,function(a){var b=a.split("=");c(b.shift(),b.join("="))})}var f=/^\?(.*)/,g=/\((.*?)\)/g,h=/(\(\?)?:\w+/g,i=/\*\w+/g,j=/[\-{}\[\]+?.,\\\^$|#\s]/g,k=/^([^\?]*)/,l=/[\:\*]([^\:\?\/]+)/g,m=/^[#\/]|\s+$/g,n=/\/$/;b.Router.arrayValueSplit="|",a.extend(b.History.prototype,{getFragment:function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){a=this.location.pathname;var c=this.root.replace(n,""),d=this.location.search;a.indexOf(c)||(a=a.substr(c.length)),d&&this._hasPushState&&(a+=d)}else a=this.getHash();return a.replace(m,"")},getQueryParameters:function(b,c){b=this.getFragment(b,c);var g=b.replace(k,""),h=g.match(f);if(h){g=h[1];var i={};return e(g,function(b,c){c=d(c),i[b]?a.isString(i[b])?i[b]=[i[b],c]:i[b].push(c):i[b]=c}),i}return{}}}),a.extend(b.Router.prototype,{initialize:function(a){this.encodedSplatParts=a&&a.encodedSplatParts},_routeToRegExp:function(b){var c=i.exec(b)||{index:-1},d=h.exec(b)||{index:-1},e=b.match(l)||[];b=b.replace(j,"\\$&").replace(g,"(?:$1)?").replace(h,function(a,b){return b?a:"([^\\/\\?]+)"}).replace(i,"([^??]*?)"),b+="(\\?.*)?";var f=new RegExp("^"+b+"$");return c.index>=0&&(d>=0?f.splatMatch=c.index-d.index:f.splatMatch=-1),f.paramNames=a.map(e,function(a){return a.replace(/\)$/,"").substring(1)}),f.namedParameters=this.namedParameters,f},_extractParameters:function(c,g){var h=c.exec(g).slice(1),i={};h.length>0&&!h[h.length-1]&&h.splice(h.length-1,1);var j=h.length&&h[h.length-1]&&h[h.length-1].match(f);if(j){var k=j[1],l={};if(k){var m=this;e(k,function(a,b){m._setParamValue(a,b,l)})}h[h.length-1]=l,a.extend(i,l)}var n=h.length;if(c.splatMatch&&this.encodedSplatParts){if(c.splatMatch<0)return h;n-=1}for(var o=0;n>o;o++)a.isString(h[o])&&(h[o]=d(h[o]),c.paramNames&&c.paramNames.length>=o-1&&(i[c.paramNames[o]]=h[o]));return b.Router.namedParameters||c.namedParameters?[i]:h},_setParamValue:function(a,b,c){a=a.replace("[]",""),a=a.replace("%5B%5D","");for(var d=a.split("."),e=c,f=0;f<d.length;f++){var g=d[f];f===d.length-1?e[g]=this._decodeParamValue(b,e[g]):e=e[g]=e[g]||{}}},_decodeParamValue:function(c,e){var f=b.Router.arrayValueSplit;if(f&&c.indexOf(f)>=0){for(var g=c.split(f),h=g.length-1;h>=0;h--)g[h]?g[h]=d(g[h]):g.splice(h,1);return g}return c=d(c),e?a.isArray(e)?(e.push(c),e):[e,c]:c},toFragment:function(b,d){return d&&(a.isString(d)||(d=c(d)),d&&(b+="?"+d)),b}})});